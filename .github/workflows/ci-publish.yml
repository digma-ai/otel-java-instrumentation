
name: Publish

on:
  # Triggers the workflow on push of tags (release)
  push:
    branches: [ feat/gha-publish ]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  # This workflow contains a single job called "build"
  publish:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    steps:
      - name: Extract branch name
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - name: Echo vars
        run: |
          echo "GITHUB_REF     = ${GITHUB_REF}"
          echo "GITHUB_REF##   = ${GITHUB_REF##*/}"
          echo "extract_branch = ${{ steps.extract_branch.outputs.branch }}"
          echo "GITHUB_BASE_REF   = ${GITHUB_BASE_REF}"
          echo "GITHUB_TARGET_REF = ${GITHUB_TARGET_REF}"

      - name: GIT Checkout
        uses: actions/checkout@v3
        with:
          ref: feat/gha-publish

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: temurin

      - name: Get tag
        id: tag
        uses: dawidd6/action-get-tag@v1
        with:
          # Optionally strip `v` prefix
          strip_v: true

      - name: update version in version.gradle.kts
        run: |
          ./scripts/update_version.sh ${{ steps.tag.outputs.tag }}
          cat version.gradle.kts
          echo "GITHUB_REF_NAME = $GITHUB_REF_NAME"
          git branch --show-current
          git status

      - name: Commit version file
        run: |
          curr_branch="`git branch --show-current`"
          git checkout $curr_branch
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add version.gradle.kts
          git commit -m "bump version ${{ steps.tag.outputs.tag }}"
          git push

      - name: Build with Gradle
        run: |
          ./gradlew clean
          ./gradlew build
